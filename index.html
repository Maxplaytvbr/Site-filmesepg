<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>MaxPlay TV - Guia</title>
    <meta content="Guia MaxPlay TV com programa√ß√£o atualizada dos melhores canais, filmes e s√©ries." name="description"/>
    <meta content="MaxPlay TV - Guia" property="og:title"/>
    <meta content="Veja a programa√ß√£o de hoje com filmes, s√©ries e canais ao vivo." property="og:description"/>
    <meta content="https://i.postimg.cc/BvbCr0jH/IMG-6850.png" property="og:image"/>
    <link href="https://i.postimg.cc/BvbCr0jH/IMG-6850.png" rel="icon"/>
    <!-- Fontes -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos otimizados */
        body {
            background-color: #0f172a;
            color: #f8fafc;
            font-family: 'Poppins', sans-serif;
        }
        
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #ff6b00;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .category-title {
            position: relative;
            padding-left: 15px;
        }
        
        .category-title::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 5px;
            height: 80%;
            background-color: #ff6b00;
            border-radius: 2px;
        }
        
        .channel-card {
            background-color: rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 107, 0, 0.3);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            min-height: 240px;
            overflow: hidden;
        }
        
        .channel-card:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .filter-btn.active {
            background-color: #ff6b00 !important;
            color: white !important;
            border-bottom: 2px solid white;
        }
        
        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 107, 0, 0.5);
        }
    </style>
</head>
<body>
    <!-- Cabe√ßalho -->
    <header class="mb-6">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
            <div class="flex items-center mb-4 md:mb-0">
                <img alt="MaxPlay TV Logo" class="h-12 mr-3" src="https://i.postimg.cc/BvbCr0jH/IMG-6850.png"/>
                <h1 class="text-2xl font-bold text-white">MaxPlay TV <span class="text-orange-500">‚Äì Guia</span></h1>
            </div>
            <div class="flex flex-col sm:flex-row w-full md:w-auto gap-2">
                <div class="relative flex-grow">
                    <input class="w-full p-2 pl-3 pr-10 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-orange-500" id="channel-search" placeholder="Buscar canal ou programa..." type="text"/>
                    <svg aria-hidden="true" class="h-5 w-5 absolute right-3 top-2.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <button class="px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-opacity-90 transition-colors whitespace-nowrap" id="reload-epg">
                    <svg aria-hidden="true" class="h-5 w-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Recarregar
                </button>
            </div>
        </div>
        <div class="flex justify-between items-center mb-4">
            <div class="current-time bg-gray-800 border border-gray-700 rounded-md px-3 py-1 text-sm flex items-center">
                <svg aria-hidden="true" class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span id="current-time-display">Carregando...</span>
            </div>
            <div class="text-sm text-gray-400">
                √öltima atualiza√ß√£o: <span id="last-update">Carregando...</span>
            </div>
        </div>
    </header>

    <!-- Se√ß√£o Principal -->
    <div class="container mx-auto px-4 py-6">
        <div class="flex justify-center items-center h-40" id="loading">
            <div class="loading-spinner"></div>
            <p class="ml-4 text-gray-300">Carregando programa√ß√£o...</p>
        </div>
        
        <div class="hidden bg-red-900 border border-red-700 text-white px-4 py-3 rounded mb-4" id="error-message"></div>
        
        <h2 class="text-2xl font-bold mb-4 text-orange-500">üì∫ CANAIS E PROGRAMA√á√ÉO</h2>
        
        <!-- Filtros -->
        <div class="filters-container overflow-x-auto pb-2">
            <div class="flex space-x-2 mb-4">
                <button class="filter-btn px-3 py-1.5 rounded-md bg-gray-800 text-sm font-medium" data-filter="favorites">
                    <svg aria-hidden="true" class="h-4 w-4 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                    </svg>
                    Favoritos
                </button>
                <button class="filter-btn active px-3 py-1.5 rounded-md bg-gray-800 text-sm font-medium" data-filter="all">Todos</button>
                <button class="filter-btn px-3 py-1.5 rounded-md bg-gray-800 text-sm font-medium" data-filter="movies">Filmes/S√©ries</button>
                <button class="filter-btn px-3 py-1.5 rounded-md bg-gray-800 text-sm font-medium" data-filter="documentary">Document√°rios</button>
                <button class="filter-btn px-3 py-1.5 rounded-md bg-gray-800 text-sm font-medium" data-filter="kids">Infantis</button>
                <button class="filter-btn px-3 py-1.5 rounded-md bg-gray-800 text-sm font-medium" data-filter="sports">Esportes</button>
                <button class="filter-btn px-3 py-1.5 rounded-md bg-gray-800 text-sm font-medium" data-filter="news">Not√≠cias</button>
                <button class="filter-btn px-3 py-1.5 rounded-md bg-gray-800 text-sm font-medium" data-filter="open">Abertos</button>
                <button class="filter-btn px-3 py-1.5 rounded-md bg-gray-800 text-sm font-medium" data-time="morning">Manh√£</button>
                <button class="filter-btn px-3 py-1.5 rounded-md bg-gray-800 text-sm font-medium" data-time="afternoon">Tarde</button>
                <button class="filter-btn px-3 py-1.5 rounded-md bg-gray-800 text-sm font-medium" data-time="evening">Noite</button>
            </div>
        </div>
        
        <!-- Canais -->
        <div class="hidden" id="channels-container">
            <section class="mb-8" id="movies-section">
                <h2 class="category-title text-xl font-bold mb-4 text-orange-500">Filmes e S√©ries</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="movies-channels"></div>
            </section>
            
            <section class="mb-8" id="documentary-section">
                <h2 class="category-title text-xl font-bold mb-4 text-orange-500">Document√°rios</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="documentary-channels"></div>
            </section>
            
            <section class="mb-8" id="kids-section">
                <h2 class="category-title text-xl font-bold mb-4 text-orange-500">Infantis</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="kids-channels"></div>
            </section>
            
            <section class="mb-8" id="sports-section">
                <h2 class="category-title text-xl font-bold mb-4 text-orange-500">Esportes</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="sports-channels"></div>
            </section>
            
            <section class="mb-8" id="news-section">
                <h2 class="category-title text-xl font-bold mb-4 text-orange-500">Not√≠cias</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="news-channels"></div>
            </section>
            
            <section class="mb-8" id="open-section">
                <h2 class="category-title text-xl font-bold mb-4 text-orange-500">Canais Abertos</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="open-channels"></div>
            </section>
            
            <section class="mb-8" id="other-section">
                <h2 class="category-title text-xl font-bold mb-4 text-orange-500">Outros Canais</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="other-channels"></div>
            </section>
        </div>
    </div>

    <!-- Modal de Programa√ß√£o -->
    <div class="modal fixed hidden inset-0 bg-black bg-opacity-80 z-50 overflow-y-auto" id="schedule-modal">
        <div class="modal-content bg-gray-800 mx-auto my-16 w-full max-w-3xl rounded-lg shadow-lg animate-fade-in">
            <div class="modal-header bg-gray-900 p-4 rounded-t-lg flex justify-between items-center">
                <div class="flex items-center">
                    <img alt="Channel Logo" class="h-8 mr-2" id="modal-channel-logo" src=""/>
                    <h3 class="text-lg font-bold text-white" id="modal-channel-name">Canal</h3>
                </div>
                <span class="modal-close text-gray-400 text-2xl cursor-pointer hover:text-orange-500">&times;</span>
            </div>
            <div class="modal-body p-4 max-h-[70vh] overflow-y-auto">
                <div class="space-y-3" id="modal-schedule-list"></div>
            </div>
        </div>
    </div>

    <!-- Modal de Trailer -->
    <div class="modal fixed hidden inset-0 bg-black bg-opacity-90 z-50" id="trailer-modal">
        <div class="modal-content relative bg-gray-900 mx-auto my-16 w-full max-w-4xl rounded-lg shadow-lg animate-fade-in">
            <span class="modal-close absolute top-2 right-2 text-white text-3xl cursor-pointer hover:text-orange-500">&times;</span>
            <div class="aspect-w-16 aspect-h-9" id="trailer-container">
                <div class="hidden text-center p-10 text-white" id="trailer-not-found">
                    <p>Trailer n√£o encontrado para este filme.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot√£o Voltar ao Topo -->
    <button class="fixed bottom-6 right-6 bg-orange-500 text-white p-3 rounded-full shadow-lg hidden z-50 hover:bg-orange-600 transition-all" id="back-to-top">
        <svg aria-hidden="true" class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
        </svg>
    </button>

    <script>
        // =============================================
        // Configura√ß√µes e Constantes
        // =============================================
        const CONFIG = {
            tmdbApiKey: "54b9cff0f48a3f127fa5cd5906bbe251",
            epgXmlUrl: "https://raw.githubusercontent.com/limaalef/BrazilTVEPG/main/vivoplay.xml",
            sportEventsUrls: [
                "https://raw.githubusercontent.com/limaalef/BrazilTVEPG/main/claro.xml",
                "https://raw.githubusercontent.com/limaalef/BrazilTVEPG/main/epg.xml"
            ],
            autoUpdateInterval: 60000, // 1 minuto
            maxSearchResults: 100
        };

        // Mapeamento de logos de canais
        const CHANNEL_LOGOS = {
            'Warner': 'https://i.postimg.cc/SxBRcBBk/IMG-6821.png',
            'Sony': 'https://i.postimg.cc/bwDdDyFm/IMG-6878.jpg',
            'TNT': 'https://i.postimg.cc/kXhBg6wV/IMG-6879.png',
            'TNT Novelas': 'https://i.postimg.cc/1RB8bYqr/IMG-6880.jpg',
            'Space': 'https://i.postimg.cc/D0xms8TM/IMG-6881.jpg',
            'Cinemax': 'https://i.postimg.cc/x8fccLWm/IMG-6882.jpg',
            'Megapix': 'https://i.postimg.cc/fLjVz8gZ/IMG-6883.jpg',
            'Sony Movies': 'https://i.postimg.cc/mDGcWvj8/IMG-6884.jpg',
            'Fox': 'https://i.postimg.cc/0NS63kYz/IMG-6885.jpg',
            'Animal Planet': 'https://i.postimg.cc/pXdmvYQb/IMG-6886.png',
            'History': 'https://i.postimg.cc/FH7kyg1g/IMG-6887.jpg',
            'Discovery Kids': 'https://i.postimg.cc/bwWD3DtX/IMG-6888.png',
            'Band': 'https://i.postimg.cc/c41nHNSz/IMG-6889.png',
            'Band Sports': 'https://i.postimg.cc/Pr68vFf5/IMG-6890.png',
            'Globo': 'https://logodownload.org/wp-content/uploads/2013/12/rede-globo-logo-0.png',
            'SBT': 'https://logodownload.org/wp-content/uploads/2013/12/sbt-logo-0.png',
            'Record': 'https://logodownload.org/wp-content/uploads/2014/02/record-logo-tv-0.png',
            'HBO': 'https://logodownload.org/wp-content/uploads/2017/04/hbo-logo-1.png',
            'Telecine': 'https://logodownload.org/wp-content/uploads/2017/07/telecine-logo-1.png',
            'SporTV': 'https://logodownload.org/wp-content/uploads/2017/07/sportv-logo-0.png',
            'ESPN': 'https://logodownload.org/wp-content/uploads/2015/05/espn-logo-4.png',
            'Discovery': 'https://logodownload.org/wp-content/uploads/2017/04/discovery-channel-logo-1.png',
            'Cartoon Network': 'https://logodownload.org/wp-content/uploads/2018/06/cartoon-network-logo-1.png',
            'Nickelodeon': 'https://logodownload.org/wp-content/uploads/2018/07/nickelodeon-logo-1.png',
            'Disney': 'https://logodownload.org/wp-content/uploads/2018/10/disney-channel-logo-1.png',
            'GloboNews': 'https://logodownload.org/wp-content/uploads/2017/07/globo-news-logo-0.png',
            'CNN Brasil': 'https://logodownload.org/wp-content/uploads/2020/02/cnn-brasil-logo-0.png',
            "AMC": "https://i.postimg.cc/t4vK31X0/IMG-6911.jpg",
            "AXN": "https://i.postimg.cc/qM4H4VmF/IMG-6909.jpg",
            "A&E": "https://i.postimg.cc/15BhzC23/IMG-6912.png",
            "Prime Box Brazil": "https://i.postimg.cc/2yYMkhxW/IMG-6913.png",
            "Comedy Central": "https://i.postimg.cc/k5kLHk6f/IMG-6914.png",
            "Paramount Network": "https://i.postimg.cc/KzBChJtF/IMG-6915.png",
            "Travel Box": "https://i.postimg.cc/xjGBsp03/IMG-6916.png",
            "TLC": "https://i.postimg.cc/Prt90bJs/IMG-6917.png",
            "E!": "https://i.postimg.cc/SND34XYX/IMG-6918.jpg",
            "Arte 1": "https://i.postimg.cc/VkvTkYXK/IMG-6919.png",
            "Fish": "https://i.postimg.cc/T3ssyZ9f/IMG-6920.png",
            "Nick Jr.": "https://i.postimg.cc/Xqn1S3Vc/IMG-6924.png",
            "Nickelodeon": "https://i.postimg.cc/yNSb0vQ9/IMG-6921.png",
            "Cartoon Network": "https://i.postimg.cc/ZRtDHp2Q/IMG-6922.png",
            "Cartoonito": "https://i.postimg.cc/hjLZ5hqt/IMG-6923.png",
            "Premiere": "https://i.postimg.cc/dQ9SR7BW/IMG-6926.png",
            "Record": "https://i.postimg.cc/Vv4GzTvy/IMG-6925.png",
            "RedeTV!": "https://i.postimg.cc/xTTp60p9/IMG-6927.png"
        };

        // Categorias de canais
        const CHANNEL_CATEGORIES = {
            'movies': ['HBO', 'HBO2', 'HBO Plus', 'HBO Family', 'HBO Signature', 'HBO Mundi', 'HBO Pop', 'HBO Xtreme', 
                      'Telecine Premium', 'Telecine Action', 'Telecine Touch', 'Telecine Fun', 'Telecine Pipoca', 'Telecine Cult',
                      'Megapix', 'Universal TV', 'Studio Universal', 'Warner', 'AXN', 'Sony', 'FX', 'Paramount Network',
                      'Cinemax', 'Prime Box Brazil', 'TNT', 'TNT Series', 'TNT Novelas', 'Space', 'AMC', 'Film&Arts', 'Syfy', 'Comedy Central',
                      'TBS', 'A&E', 'Star Channel', 'Lifetime', 'Canal Brasil', 'TCM', 'Cine Brasil TV', 'CineBrasilTV', 'Sony Movies', 'Fox'],
            
            'documentary': ['Discovery Channel', 'Animal Planet', 'Nat Geo', 'National Geographic', 'History', 'History 2', 'Discovery Science', 
                           'Discovery Theater', 'Discovery World', 'Discovery Turbo', 'Discovery Home & Health', 'Discovery ID', 'TLC', 
                           'E!', 'Curta!', 'Arte 1', 'Fashion TV', 'Travel Box Brazil', 'Fish TV', 'Smithsonian Channel'],
            
            'kids': ['Cartoon Network', 'Nickelodeon', 'Nick Jr.', 'Disney Channel', 'Disney Junior', 'Discovery Kids', 'Gloob', 
                    'Gloobinho', 'Tooncast', 'Cartoonito', 'ZooMoo', 'TV R√°-Tim-Bum', 'Nat Geo Kids'],
            
            'sports': ['SporTV', 'SporTV 2', 'SporTV 3', 'ESPN', 'ESPN 2', 'ESPN 3', 'ESPN 4', 'Fox Sports', 'Fox Sports 2', 
                      'Band Sports', 'Premiere', 'Premiere 2', 'Premiere 3', 'Premiere 4', 'Premiere 5', 'Premiere 6', 
                      'Premiere 7', 'Premiere 8', 'Combate', 'OFF', 'Woohoo'],
            
            'news': ['GloboNews', 'CNN Brasil', 'Record News', 'BandNews', 'Jovem Pan News', 'Bloomberg'],
            
            'open': ['Globo', 'SBT', 'Record', 'Band', 'RedeTV!', 'TV Cultura', 'TV Brasil', 'TV Gazeta', 'Futura', 'TV C√¢mara', 'TV Senado', 'TV Justi√ßa'],
            
            'adult': ['Playboy TV', 'Sexy Hot', 'Venus', 'Sextreme', 'Hustler TV', 'Penthouse TV']
        };

        // Classifica√ß√£o indicativa
        const RATING_IMAGES = {
            'L': 'https://i.postimg.cc/7PnzwZp7/IMG-6891.png',
            '10': 'https://i.postimg.cc/FzpkZTjG/IMG-6892.png',
            '12': 'https://i.postimg.cc/LXz1q95c/IMG-6893.png',
            '14': 'https://i.postimg.cc/sxsZ7kZv/IMG-6894.png',
            '16': 'https://i.postimg.cc/wvKNTyq5/IMG-6895.png',
            '18': 'https://i.postimg.cc/LsgfpBp6/IMG-6896.png'
        };

        // Dias da semana abreviados
        const WEEKDAYS_SHORT = ['dom', 'seg', 'ter', 'qua', 'qui', 'sex', 'sab'];

        // =============================================
        // M√≥dulo Principal
        // =============================================
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar aplica√ß√£o
            initApplication();
        });

        function initApplication() {
            // Cache de elementos DOM
            const DOM = {
                loading: document.getElementById('loading'),
                error: document.getElementById('error-message'),
                channelsContainer: document.getElementById('channels-container'),
                searchInput: document.getElementById('channel-search'),
                reloadButton: document.getElementById('reload-epg'),
                currentTimeDisplay: document.getElementById('current-time-display'),
                lastUpdateDisplay: document.getElementById('last-update'),
                backToTopButton: document.getElementById('back-to-top'),
                modal: document.getElementById('schedule-modal'),
                modalClose: document.querySelector('#schedule-modal .modal-close'),
                modalChannelName: document.getElementById('modal-channel-name'),
                modalChannelLogo: document.getElementById('modal-channel-logo'),
                modalScheduleList: document.getElementById('modal-schedule-list'),
                trailerModal: document.getElementById('trailer-modal'),
                trailerClose: document.querySelector('#trailer-modal .modal-close'),
                trailerContainer: document.getElementById('trailer-container'),
                trailerNotFound: document.getElementById('trailer-not-found')
            };

            // Estado da aplica√ß√£o
            const APP_STATE = {
                allProgrammes: {},
                favoriteChannels: JSON.parse(localStorage.getItem('favoriteChannels')) || {},
                trailerCache: JSON.parse(localStorage.getItem('trailerCache')) || {},
                autoUpdateTimer: null,
                currentFilter: 'all',
                currentTimeFilter: null
            };

            // Inicializar funcionalidades
            initTimeUpdater();
            initScrollToTop();
            initModals();
            initEventListeners();
            fetchEPGData();

            // =============================================
            // Fun√ß√µes de Inicializa√ß√£o
            // =============================================

            function initTimeUpdater() {
                updateCurrentTime();
                setInterval(updateCurrentTime, 1000);
                
                function updateCurrentTime() {
                    const now = new Date();
                    DOM.currentTimeDisplay.textContent = now.toLocaleTimeString('pt-BR', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                }
            }

            function initScrollToTop() {
                window.addEventListener('scroll', () => {
                    if (window.pageYOffset > 300) {
                        DOM.backToTopButton.classList.remove('hidden');
                    } else {
                        DOM.backToTopButton.classList.add('hidden');
                    }
                });
                
                DOM.backToTopButton.addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }

            function initModals() {
                // Modal de programa√ß√£o
                DOM.modalClose.addEventListener('click', () => DOM.modal.style.display = 'none');
                window.addEventListener('click', (e) => {
                    if (e.target === DOM.modal) DOM.modal.style.display = 'none';
                });

                // Modal de trailer
                DOM.trailerClose.addEventListener('click', closeTrailerModal);
                window.addEventListener('click', (e) => {
                    if (e.target === DOM.trailerModal) closeTrailerModal();
                });

                function closeTrailerModal() {
                    DOM.trailerModal.style.display = 'none';
                    const iframe = DOM.trailerContainer.querySelector('iframe');
                    if (iframe) iframe.remove();
                    DOM.trailerNotFound.classList.add('hidden');
                }
            }

            function initEventListeners() {
                // Busca
                DOM.searchInput.addEventListener('input', handleSearch);
                
                // Recarregar
                DOM.reloadButton.addEventListener('click', handleReload);
                
                // Filtros
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (this.dataset.time) {
                            handleTimeFilter(this.dataset.time);
                        } else {
                            handleCategoryFilter(this.dataset.filter);
                        }
                    });
                });
            }

            // =============================================
            // Fun√ß√µes Principais
            // =============================================

            async function fetchEPGData() {
                try {
                    DOM.loading.classList.remove('hidden');
                    DOM.channelsContainer.classList.add('hidden');
                    DOM.error.classList.add('hidden');
                    
                    const response = await fetchWithTimeout(CONFIG.epgXmlUrl);
                    const xmlDoc = new DOMParser().parseFromString(response, 'text/xml');
                    
                    processEPGData(xmlDoc);
                    
                    // Atualizar UI
                    const now = new Date();
                    DOM.lastUpdateDisplay.textContent = now.toLocaleTimeString('pt-BR', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    // Iniciar atualiza√ß√£o autom√°tica
                    if (APP_STATE.autoUpdateTimer) clearInterval(APP_STATE.autoUpdateTimer);
                    APP_STATE.autoUpdateTimer = setInterval(updateProgrammesDisplay, CONFIG.autoUpdateInterval);
                    
                } catch (error) {
                    console.error('Erro ao carregar EPG:', error);
                    showError(`Erro ao carregar a programa√ß√£o: ${error.message}`);
                }
            }

            function processEPGData(xmlDoc) {
                try {
                    const channels = xmlDoc.getElementsByTagName('channel');
                    const programmes = xmlDoc.getElementsByTagName('programme');
                    
                    // Agrupar programas por canal
                    APP_STATE.allProgrammes = {};
                    for (let i = 0; i < programmes.length; i++) {
                        const programme = programmes[i];
                        const channelId = programme.getAttribute('channel');
                        
                        if (!APP_STATE.allProgrammes[channelId]) {
                            APP_STATE.allProgrammes[channelId] = [];
                        }
                        
                        APP_STATE.allProgrammes[channelId].push(programme);
                    }
                    
                    // Processar cada canal
                    const channelContainers = {
                        'movies': document.getElementById('movies-channels'),
                        'documentary': document.getElementById('documentary-channels'),
                        'kids': document.getElementById('kids-channels'),
                        'sports': document.getElementById('sports-channels'),
                        'news': document.getElementById('news-channels'),
                        'open': document.getElementById('open-channels'),
                        'other': document.getElementById('other-channels')
                    };
                    
                    // Limpar containers
                    Object.values(channelContainers).forEach(container => {
                        container.innerHTML = '';
                    });
                    
                    for (let i = 0; i < channels.length; i++) {
                        const channel = channels[i];
                        const channelId = channel.getAttribute('id');
                        const displayName = channel.getElementsByTagName('display-name')[0]?.textContent || 'Canal sem nome';
                        
                        // Determinar categoria
                        let category = 'other';
                        for (const [cat, channelList] of Object.entries(CHANNEL_CATEGORIES)) {
                            if (channelList.some(name => displayName.includes(name))) {
                                category = cat;
                                break;
                            }
                        }
                        
                        // Criar e adicionar card
                        const card = createChannelCard(displayName, channelId);
                        channelContainers[category].appendChild(card);
                    }
                    
                    // Atualizar UI
                    DOM.loading.classList.add('hidden');
                    DOM.channelsContainer.classList.remove('hidden');
                    applyCurrentFilters();
                    
                } catch (error) {
                    console.error('Erro ao processar EPG:', error);
                    showError(`Erro ao processar a programa√ß√£o: ${error.message}`);
                }
            }

            function createChannelCard(channelName, channelId) {
                const card = document.createElement('div');
                card.className = 'channel-card';
                card.dataset.channelId = channelId;
                card.dataset.channelName = channelName.toLowerCase();
                
                // Cabe√ßalho
                const header = document.createElement('div');
                header.className = 'bg-gray-800 p-3 flex items-center min-h-[60px]';
                
                // Logo
                const logoElement = document.createElement('img');
                logoElement.className = 'h-8 w-8 min-w-[32px] mr-2 object-contain';
                logoElement.src = getChannelLogo(channelName);
                logoElement.alt = `${channelName} Logo`;
                logoElement.onerror = function() {
                    this.onerror = null;
                    this.src = `https://via.placeholder.com/50x30/1a1a2e/ffffff?text=${encodeURIComponent(channelName.substring(0, 3))}`;
                };
                
                // Nome
                const nameElement = document.createElement('h3');
                nameElement.className = 'channel-name text-sm font-semibold text-white';
                nameElement.textContent = channelName.length > 20 ? 
                    channelName.substring(0, 20) + '...' : channelName;
                nameElement.title = channelName;
                
                // Favorito
                const isFavorite = APP_STATE.favoriteChannels[channelId];
                const starIcon = document.createElement('span');
                starIcon.className = `favorite-star ml-auto ${isFavorite ? 'active' : ''}`;
                starIcon.innerHTML = '‚òÖ';
                starIcon.dataset.channel = channelId;
                starIcon.onclick = (e) => {
                    e.stopPropagation();
                    toggleFavorite(channelId, starIcon);
                };
                
                // Programa√ß√£o
                const programmesList = document.createElement('div');
                programmesList.className = 'programmes-list p-3 space-y-2 flex-grow';
                
                const channelProgrammes = APP_STATE.allProgrammes[channelId] || [];
                const currentProgrammes = getCurrentProgrammes(channelProgrammes).slice(0, 2);
                
                if (currentProgrammes.length === 0) {
                    programmesList.innerHTML = '<p class="text-gray-400 italic text-sm">Nenhuma programa√ß√£o dispon√≠vel</p>';
                } else {
                    currentProgrammes.forEach((programme, index) => {
                        programmesList.appendChild(createProgrammeItem(programme, index === 0));
                    });
                }
                
                // Bot√£o programa√ß√£o completa
                const button = document.createElement('button');
                button.className = 'mt-auto mx-3 mb-3 py-1.5 text-sm bg-orange-500 hover:bg-orange-600 text-white rounded';
                button.textContent = 'Programa√ß√£o completa';
                button.onclick = () => showFullSchedule(channelName, channelId, logoElement.src);
                
                // Montar card
                header.appendChild(logoElement);
                header.appendChild(nameElement);
                header.appendChild(starIcon);
                
                card.appendChild(header);
                card.appendChild(programmesList);
                card.appendChild(button);
                
                return card;
            }

            function toggleFavorite(channelId, starElement) {
                APP_STATE.favoriteChannels[channelId] = !APP_STATE.favoriteChannels[channelId];
                localStorage.setItem('favoriteChannels', JSON.stringify(APP_STATE.favoriteChannels));
                
                starElement.classList.toggle('active');
                
                // Se o filtro de favoritos estiver ativo, atualizar exibi√ß√£o
                if (APP_STATE.currentFilter === 'favorites') {
                    applyCurrentFilters();
                }
            }

            function showFullSchedule(channelName, channelId, logoUrl) {
                DOM.modalChannelName.textContent = channelName;
                DOM.modalChannelLogo.src = logoUrl;
                DOM.modalChannelLogo.alt = `${channelName} Logo`;
                DOM.modalScheduleList.innerHTML = '';
                
                const channelProgrammes = APP_STATE.allProgrammes[channelId] || [];
                const now = new Date();
                
                // Filtrar programas futuros
                const futureProgrammes = channelProgrammes
                    .filter(programme => {
                        const endTime = parseEPGDate(programme.getAttribute('stop'));
                        return endTime > now;
                    })
                    .sort((a, b) => {
                        const startA = parseEPGDate(a.getAttribute('start'));
                        const startB = parseEPGDate(b.getAttribute('start'));
                        return startA - startB;
                    });
                
                if (futureProgrammes.length === 0) {
                    DOM.modalScheduleList.innerHTML = '<p class="text-gray-400 italic text-center py-4">Nenhuma programa√ß√£o dispon√≠vel</p>';
                } else {
                    // Agrupar por data
                    const programmesByDate = {};
                    futureProgrammes.forEach(programme => {
                        const startTime = parseEPGDate(programme.getAttribute('start'));
                        const dateKey = startTime.toLocaleDateString('pt-BR');
                        
                        if (!programmesByDate[dateKey]) {
                            programmesByDate[dateKey] = [];
                        }
                        
                        programmesByDate[dateKey].push(programme);
                    });
                    
                    // Adicionar ao modal
                    Object.entries(programmesByDate).forEach(([date, programmes]) => {
                        const dateHeader = document.createElement('div');
                        dateHeader.className = 'text-orange-500 font-bold text-lg mb-2 border-b border-gray-700 pb-1';
                        dateHeader.textContent = date;
                        DOM.modalScheduleList.appendChild(dateHeader);
                        
                        programmes.forEach(programme => {
                            DOM.modalScheduleList.appendChild(createProgrammeItem(programme, true));
                        });
                    });
                }
                
                DOM.modal.style.display = 'block';
            }

            // =============================================
            // Fun√ß√µes de Filtro
            // =============================================

            function handleCategoryFilter(filter) {
                // Atualizar bot√µes ativos
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    if (!btn.dataset.time) {
                        btn.classList.remove('active');
                    }
                });
                
                event.target.classList.add('active');
                APP_STATE.currentFilter = filter;
                applyCurrentFilters();
            }

            function handleTimeFilter(timeRange) {
                // Atualizar bot√µes ativos
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    if (btn.dataset.time) {
                        btn.classList.remove('active');
                    }
                });
                
                event.target.classList.add('active');
                APP_STATE.currentTimeFilter = timeRange;
                applyCurrentFilters();
            }

            function applyCurrentFilters() {
                const channelCards = document.querySelectorAll('.channel-card');
                const now = new Date();
                const currentHour = now.getHours();
                
                channelCards.forEach(card => {
                    let shouldShow = true;
                    
                    // Aplicar filtro de categoria
                    if (APP_STATE.currentFilter === 'favorites') {
                        shouldShow = APP_STATE.favoriteChannels[card.dataset.channelId];
                    } else if (APP_STATE.currentFilter !== 'all') {
                        const category = Object.keys(CHANNEL_CATEGORIES).find(cat => 
                            CHANNEL_CATEGORIES[cat].some(name => card.dataset.channelName.includes(name.toLowerCase()))
                        shouldShow = category === APP_STATE.currentFilter;
                    }
                    
                    // Aplicar filtro de hor√°rio
                    if (shouldShow && APP_STATE.currentTimeFilter) {
                        const programmes = card.querySelectorAll('.programme-item');
                        let hasMatchingProgramme = false;
                        
                        programmes.forEach(item => {
                            const timeText = item.querySelector('.programme-time').textContent;
                            const hourMatch = timeText.match(/(\d{1,2}):\d{2}/);
                            if (!hourMatch) return;
                            
                            const hour = parseInt(hourMatch[1]);
                            let matchesTime = false;
                            
                            switch(APP_STATE.currentTimeFilter) {
                                case 'morning':
                                    matchesTime = hour >= 6 && hour < 12;
                                    break;
                                case 'afternoon':
                                    matchesTime = hour >= 12 && hour < 18;
                                    break;
                                case 'evening':
                                    matchesTime = hour >= 18 || hour < 6;
                                    break;
                            }
                            
                            if (matchesTime) {
                                hasMatchingProgramme = true;
                                item.style.display = 'block';
                            } else {
                                item.style.display = 'none';
                            }
                        });
                        
                        shouldShow = hasMatchingProgramme;
                    }
                    
                    card.style.display = shouldShow ? 'flex' : 'none';
                });
                
                // Mostrar/ocultar se√ß√µes vazias
                checkEmptySections();
            }

            function checkEmptySections() {
                const sections = [
                    { id: 'movies-section', container: 'movies-channels' },
                    { id: 'documentary-section', container: 'documentary-channels' },
                    { id: 'kids-section', container: 'kids-channels' },
                    { id: 'sports-section', container: 'sports-channels' },
                    { id: 'news-section', container: 'news-channels' },
                    { id: 'open-section', container: 'open-channels' },
                    { id: 'other-section', container: 'other-channels' }
                ];
                
                sections.forEach(section => {
                    const sectionEl = document.getElementById(section.id);
                    const container = document.getElementById(section.container);
                    const visibleCards = container.querySelectorAll('.channel-card:not([style*="display: none"])');
                    
                    sectionEl.style.display = visibleCards.length > 0 ? 'block' : 'none';
                });
            }

            function handleSearch() {
                const searchTerm = DOM.searchInput.value.toLowerCase().trim();
                
                if (!searchTerm) {
                    applyCurrentFilters();
                    return;
                }
                
                const channelCards = document.querySelectorAll('.channel-card');
                
                channelCards.forEach(card => {
                    const channelName = card.dataset.channelName;
                    const programmes = Array.from(card.querySelectorAll('.programme-title')).map(el => 
                        el.textContent.toLowerCase()
                    );
                    
                    const matches = channelName.includes(searchTerm) || 
                                  programmes.some(prog => prog.includes(searchTerm));
                    
                    card.style.display = matches ? 'flex' : 'none';
                });
                
                checkEmptySections();
            }

            function handleReload() {
                fetchEPGData();
            }

            // =============================================
            // Fun√ß√µes Auxiliares
            // =============================================

            function parseEPGDate(dateString) {
                const year = parseInt(dateString.substring(0, 4));
                const month = parseInt(dateString.substring(4, 6)) - 1;
                const day = parseInt(dateString.substring(6, 8));
                const hour = parseInt(dateString.substring(8, 10));
                const minute = parseInt(dateString.substring(10, 12));
                const second = parseInt(dateString.substring(12, 14));
                
                return new Date(year, month, day, hour, minute, second);
            }

            function getCurrentProgrammes(programmes) {
                const now = new Date();
                const sorted = [...programmes].sort((a, b) => {
                    const startA = parseEPGDate(a.getAttribute('start'));
                    const startB = parseEPGDate(b.getAttribute('start'));
                    return startA - startB;
                });
                
                // Encontrar programa atual
                let currentIndex = -1;
                for (let i = 0; i < sorted.length; i++) {
                    const start = parseEPGDate(sorted[i].getAttribute('start'));
                    const end = parseEPGDate(sorted[i].getAttribute('stop'));
                    
                    if (start <= now && end > now) {
                        currentIndex = i;
                        break;
                    }
                }
                
                // Se n√£o encontrou programa atual, pega o pr√≥ximo
                if (currentIndex === -1) {
                    for (let i = 0; i < sorted.length; i++) {
                        const start = parseEPGDate(sorted[i].getAttribute('start'));
                        if (start > now) {
                            currentIndex = i;
                            break;
                        }
                    }
                }
                
                return currentIndex === -1 ? [] : sorted.slice(currentIndex, currentIndex + 5);
            }

            function createProgrammeItem(programme, isDetailed = false) {
                const start = parseEPGDate(programme.getAttribute('start'));
                const end = parseEPGDate(programme.getAttribute('stop'));
                const title = programme.getElementsByTagName('title')[0]?.textContent || 'Sem t√≠tulo';
                const desc = programme.getElementsByTagName('desc')[0]?.textContent || '';
                
                // Classifica√ß√£o indicativa
                let rating = null;
                const ratingElements = programme.getElementsByTagName('rating');
                if (ratingElements.length > 0) {
                    const valueElement = ratingElements[0].getElementsByTagName('value')[0];
                    if (valueElement) rating = valueElement.textContent;
                }
                
                const item = document.createElement('div');
                item.className = isDetailed ? 
                    'bg-gray-800 bg-opacity-30 rounded-md p-3 mb-2' : 
                    'programme-item';
                
                // Destacar programa atual
                const now = new Date();
                if (start <= now && end > now) {
                    item.classList.add(isDetailed ? 'border border-orange-500' : 'bg-gray-800 bg-opacity-30');
                }
                
                // Hor√°rio
                const timeElement = document.createElement('div');
                timeElement.className = isDetailed ? 
                    'flex items-center text-sm font-medium text-orange-500 mb-1' : 
                    'programme-time text-xs text-orange-400 flex items-center';
                
                const startWeekday = WEEKDAYS_SHORT[start.getDay()];
                const endWeekday = WEEKDAYS_SHORT[end.getDay()];
                
                if (isDetailed) {
                    timeElement.innerHTML = `
                        ${start.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })} | 
                        ${startWeekday} - 
                        ${end.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })} | 
                        ${endWeekday}
                    `;
                } else {
                    timeElement.textContent = `
                        ${start.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })} - 
                        ${end.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                    `;
                }
                
                // Indicador AO VIVO
                if (start <= now && end > now) {
                    const liveIndicator = document.createElement('span');
                    liveIndicator.className = 'live-indicator';
                    liveIndicator.textContent = 'AO VIVO';
                    timeElement.appendChild(liveIndicator);
                }
                
                // T√≠tulo
                const titleElement = document.createElement('div');
                titleElement.className = isDetailed ? 'font-medium' : 'programme-title font-medium text-sm mt-1';
                titleElement.textContent = title;
                
                // Classifica√ß√£o
                const ratingImage = getRatingImage(rating);
                if (ratingImage) {
                    const ratingImg = document.createElement('img');
                    ratingImg.className = 'rating-icon ml-2';
                    ratingImg.src = ratingImage;
                    ratingImg.alt = `Classifica√ß√£o ${rating}`;
                    titleElement.appendChild(ratingImg);
                }
                
                // Descri√ß√£o (apenas no modo detalhado)
                if (isDetailed && desc) {
                    const descElement = document.createElement('div');
                    descElement.className = 'text-sm text-gray-300 mt-1';
                    descElement.textContent = desc;
                    item.appendChild(descElement);
                }
                
                // Montar item
                item.appendChild(timeElement);
                item.appendChild(titleElement);
                
                return item;
            }

            function getChannelLogo(channelName) {
                for (const [key, url] of Object.entries(CHANNEL_LOGOS)) {
                    if (channelName.includes(key)) {
                        return url;
                    }
                }
                return `https://via.placeholder.com/50x30/1a1a2e/ffffff?text=${encodeURIComponent(channelName.substring(0, 3))}`;
            }

            function getRatingImage(rating) {
                if (!rating) return null;
                
                rating = rating.toUpperCase();
                
                if (rating.includes('LIVRE') || rating === 'L') return RATING_IMAGES['L'];
                if (rating.includes('10') || rating.includes('DEZ')) return RATING_IMAGES['10'];
                if (rating.includes('12') || rating.includes('DOZE')) return RATING_IMAGES['12'];
                if (rating.includes('14') || rating.includes('QUATORZE')) return RATING_IMAGES['14'];
                if (rating.includes('16') || rating.includes('DEZESSEIS')) return RATING_IMAGES['16'];
                if (rating.includes('18') || rating.includes('DEZOITO')) return RATING_IMAGES['18'];
                
                return null;
            }

            function showError(message) {
                DOM.loading.classList.add('hidden');
                DOM.error.textContent = message;
                DOM.error.classList.remove('hidden');
            }

            async function fetchWithTimeout(resource, options = {}) {
                const { timeout = 5000 } = options;
                
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                
                try {
                    const response = await fetch(resource, { signal: controller.signal });
                    clearTimeout(id);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    return await response.text();
                } catch (error) {
                    if (error.name === 'AbortError') {
                        throw new Error('Tempo limite excedido');
                    }
                    throw error;
                }
            }

            function updateProgrammesDisplay() {
                const now = new Date();
                DOM.lastUpdateDisplay.textContent = now.toLocaleTimeString('pt-BR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                document.querySelectorAll('.channel-card').forEach(card => {
                    const channelId = card.dataset.channelId;
                    const programmesList = card.querySelector('.programmes-list');
                    const channelProgrammes = APP_STATE.allProgrammes[channelId] || [];
                    const currentProgrammes = getCurrentProgrammes(channelProgrammes).slice(0, 2);
                    
                    programmesList.innerHTML = '';
                    
                    if (currentProgrammes.length === 0) {
                        programmesList.innerHTML = '<p class="text-gray-400 italic text-sm">Nenhuma programa√ß√£o</p>';
                    } else {
                        currentProgrammes.forEach((programme, index) => {
                            programmesList.appendChild(createProgrammeItem(programme, index === 0));
                        });
                    }
                });
            }
        }
    </script>
</body>
</html>